# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

# Test partitioned table functionality
# The test_partitioned_table is created programmatically in datafusion.rs
# with partitioning on the 'category' column
# 
# Note: This test runs after insert_into.slt, so the table already has data (ids 1-6)

# Verify the partitioned table has existing data from previous test
query ITT rowsort
SELECT * FROM default.default.test_partitioned_table
----
1 electronics laptop
2 electronics phone
3 books novel
4 books textbook
5 clothing shirt
6 electronics NULL

# Test partition pruning - filter by partition column
query ITT rowsort
SELECT * FROM default.default.test_partitioned_table WHERE category = 'books'
----
3 books novel
4 books textbook

# Test partition pruning with another partition value
query ITT rowsort
SELECT * FROM default.default.test_partitioned_table WHERE category = 'electronics'
----
1 electronics laptop
2 electronics phone
6 electronics NULL

# Test filtering on non-partition column
query ITT rowsort
SELECT * FROM default.default.test_partitioned_table WHERE value = 'laptop'
----
1 electronics laptop

# Test combined filter (partition + non-partition column)
query ITT rowsort
SELECT * FROM default.default.test_partitioned_table WHERE category = 'books' AND value = 'novel'
----
3 books novel

# Test aggregation with partition column
query TI rowsort
SELECT category, COUNT(*) as count FROM default.default.test_partitioned_table GROUP BY category
----
books 2
clothing 1
electronics 3

# Insert batch data into multiple partitions (starting from id 7 since 6 exists)
query I
INSERT INTO default.default.test_partitioned_table VALUES 
  (7, 'electronics', 'tablet'),
  (8, 'books', 'magazine'),
  (9, 'clothing', 'pants')
----
3

# Verify batch insert worked
query ITT rowsort
SELECT * FROM default.default.test_partitioned_table WHERE id > 6
----
7 electronics tablet
8 books magazine
9 clothing pants

# Test NULL handling - verify existing NULL
query ITT rowsort
SELECT * FROM default.default.test_partitioned_table WHERE value IS NULL
----
6 electronics NULL

# Insert another NULL value
query I
INSERT INTO default.default.test_partitioned_table VALUES (10, 'books', NULL)
----
1

# Verify both NULL values
query ITT rowsort
SELECT * FROM default.default.test_partitioned_table WHERE value IS NULL
----
10 books NULL
6 electronics NULL

# Final count verification
query I
SELECT COUNT(*) FROM default.default.test_partitioned_table
----
10

# Verify final aggregation by partition
query TI rowsort
SELECT category, COUNT(*) as count FROM default.default.test_partitioned_table GROUP BY category ORDER BY category
----
books 4
clothing 2
electronics 4
